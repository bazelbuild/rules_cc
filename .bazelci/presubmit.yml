---
build_targets: &build_targets
  - "//:all"
  - "//cc/..."
  - "//examples/..."
  - "//tests/..."
  - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.
test_targets: &test_targets
  - "//:all"
  - "//cc/..."
  - "//examples/..."
  - "//tests/..."
  - "-//tests/system_library:system_library_test" # Only intended to work in WORKSPACE files
  - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.

build_targets_bazel_6: &build_targets_bazel_6
  - "//:all"
  - "//cc:all"
  - "//examples/..."
  - "//tests/..."
  - "-//tests/rule_based_toolchain/..." # proto.encode_text doesn't support None
  - "-//cc:optional_current_cc_toolchain" # Not supported in Bazel 6
  - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.
test_targets_bazel_6: &test_targets_bazel_6
  - "//:all"
  - "//cc:all"
  - "//examples/..."
  - "//tests/..."
  - "-//tests/rule_based_toolchain/..." # proto.encode_text doesn't support None
  - "-//cc:optional_current_cc_toolchain" # Not supported in Bazel 6
  - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.
  - "-//tests/system_library:system_library_test" # Should be skipped on Windows and MacOS

buildifier:
  version: latest

tasks:
  ubuntu2004_docs:
    name: Docs
    platform: ubuntu2004
    build_targets:
      - "//docs/..."
      - "-//docs:toolchain_api_diff_test" # Bazel adds loads statements in examples

# Bazel@HEAD
  ubuntu2004_head:
    name: Ubuntu 20.04 (Bazel HEAD)
    bazel: last_green
    platform: ubuntu2004
    build_targets: *build_targets
    test_targets:
      - "//:all"
      - "//cc/..."
      - "//examples/..."
      - "//tests/..."
      - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.
  macos_head:
    name: MacOS (Bazel HEAD)
    bazel: last_green
    platform: macos
    build_targets: *build_targets
    test_targets: *test_targets
  windows_head:
    name: Windows (Bazel HEAD)
    bazel: last_green
    platform: windows
    build_targets: *build_targets
    test_targets: *test_targets

  # Bazel@rolling
  ubuntu2004_rolling:
    name: Ubuntu 20.04 (Bazel rolling)
    bazel: rolling
    platform: ubuntu2004
    build_targets: *build_targets
    test_targets:
    - "//:all"
    - "//cc/..."
    - "//examples/..."
    - "//tests/..."
    - "-//tests/rule_based_toolchain/tool_map:_duplicate_action_test_subject" # Intentionally broken rule.
  macos_rolling:
    name: MacOS (Bazel rolling)
    bazel: rolling
    platform: macos
    build_targets: *build_targets
    test_targets: *test_targets
  windows_rolling:
    name: Windows (Bazel rolling)
    bazel: rolling
    platform: windows
    build_targets: *build_targets
    test_targets: *test_targets

# Bazel 6
  ubuntu2004_bazel_6:
    name: Ubuntu 20.04 (Bazel 6)
    bazel: 6.3.0
    platform: ubuntu2004
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  macos_bazel_6:
    name: MacOS (Bazel 6)
    bazel: 6.3.0
    platform: macos
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  windows_bazel_6:
    name: Windows (Bazel 6)
    bazel: 6.3.0
    platform: windows
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6

# Bazel 7
  ubuntu2004_bazel_7:
    name: Ubuntu 20.04 (Bazel 7)
    bazel: 7.x
    platform: ubuntu2004
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  macos_bazel_7:
    name: MacOS (Bazel 7)
    bazel: 7.x
    platform: macos
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  windows_bazel_7:
    name: Windows (Bazel 7)
    bazel: 7.x
    platform: windows
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6

# Bazel 8
  ubuntu2004_bazel_8:
    name: Ubuntu 20.04 (Bazel 8)
    bazel: 8.x
    platform: ubuntu2004
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  macos_bazel_8:
    name: MacOS (Bazel 8)
    bazel: 8.x
    platform: macos
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6
  windows_bazel_8:
    name: Windows (Bazel 8)
    bazel: 8.x
    platform: windows
    build_targets: *build_targets_bazel_6
    test_targets: *test_targets_bazel_6

# Bazel 9
  ubuntu2004:
    name: Ubuntu 20.04 (Bazel LTS)
    bazel: last_rc # TODO: change to 9.x when released
    build_targets: *build_targets
    test_targets: *test_targets
  macos:
    name: MacOS (Bazel LTS)
    bazel: last_rc # TODO: change to 9.x when released
    build_targets: *build_targets
    test_targets: *test_targets
  windows:
    name: Windows (Bazel LTS)
    bazel: last_rc # TODO: change to 9.x when released
    build_targets: *build_targets
    test_targets: *test_targets
  ubuntu_bzlmod:
    name: Ubuntu 20.04 (Bazel LTS, bzlmod)
    bazel: last_rc # TODO: change to 9.x when released
    platform: ubuntu2004
    build_flags:
      - "--enable_bzlmod"
      - "--ignore_dev_dependency"

  ubuntu_rule_based_toolchains:
    name: Ubuntu rule-based toolchains
    platform: ubuntu1804
    working_directory: examples/rule_based_toolchain
    build_flags:
      - "--enable_bzlmod"
    build_targets:
      - "//..."
    test_targets:
      - "//..."

  macos_rule_based_toolchains:
    name: macOS rule-based toolchains
    platform: macos
    working_directory: examples/rule_based_toolchain
    build_flags:
      - "--enable_bzlmod"
    build_targets:
      - "//..."

  windows_rule_based_toolchains:
    name: Windows rule-based toolchains (msvc-cl)
    platform: windows
    working_directory: examples/rule_based_toolchain
    build_flags:
      - "--enable_bzlmod"
      - "--config=msvc-cl"
    build_targets:
      - "//..."
    test_flags:
      - "--config=msvc-cl"
    test_targets:
      - "//..."
